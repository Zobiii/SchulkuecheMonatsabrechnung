<!-- 
  Schulkueche Monatsabrechnung - Community kitchen management system
  Copyright (C) 2025 Lechner Tobias
  
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published
  by the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program. If not, see <https://www.gnu.org/licenses/>.
-->

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Schulkueche.App.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="Schulkueche.App.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="Gemeinde-Küche"
        Width="1200" Height="800"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="*,Auto">
        <TabControl Grid.Row="0" SelectionChanged="OnTabSelectionChanged">
        <TabItem Header="Personen">
            <Grid RowDefinitions="* ,Auto">
                <ScrollViewer Grid.Row="0">
                    <StackPanel Spacing="12" Margin="16" DataContext="{Binding Personen}">
                        <TextBox Width="260" Watermark="Suche nach Name..." Text="{Binding FilterText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                        <Border BorderBrush="{DynamicResource ThemeBorderLowBrush}" BorderThickness="1" CornerRadius="6" Padding="12" Background="{DynamicResource ThemeControlLowBrush}">
                            <StackPanel Spacing="10">
                                <TextBlock Text="Person anlegen / bearbeiten" FontWeight="SemiBold"/>
                                <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto,Auto" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="8">
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Name:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="0" Grid.Column="1" Watermark="Vollständiger Name" Text="{Binding Name, Mode=TwoWay}"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Kategorie:" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Row="1" Grid.Column="1" SelectedIndex="{Binding Category}">
                                        <ComboBoxItem>Pensionist</ComboBoxItem>
                                        <ComboBoxItem>Kindergruppe</ComboBoxItem>
                                        <ComboBoxItem>Gratis</ComboBoxItem>
                                    </ComboBox>

                                    <CheckBox Grid.Row="1" Grid.Column="3" IsChecked="{Binding DefaultDelivery, Mode=TwoWay}" Content="Lieferung?"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Strasse:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="2" Grid.Column="1" Watermark="Straßenname" Text="{Binding Street, Mode=TwoWay}"/>
                                    <TextBlock Grid.Row="2" Grid.Column="2" Text="Hsnr:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="2" Grid.Column="3" Watermark="Nr." Text="{Binding HouseNumber, Mode=TwoWay}"/>

                                    <TextBlock Grid.Row="3" Grid.Column="2" Text="PLZ:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="3" Grid.Column="3" Watermark="PLZ" Text="{Binding Zip, Mode=TwoWay}"/>
                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Ort:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="3" Grid.Column="1" Watermark="Ort" Text="{Binding City, Mode=TwoWay}"/>

                                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Kontakt:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="4" Grid.Column="1" Watermark="Telefon / E‑Mail" Text="{Binding Contact, Mode=TwoWay}"/>

                                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Indiv. Essenspreis (€):" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="5" Grid.Column="1" Watermark="Leer lassen für Standardpreis" Text="{Binding CustomMealPriceText, Mode=TwoWay}"/>
                                </Grid>
                                <!-- Etagenträger werden jetzt in einem separaten Tab verwaltet -->

                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <Button Content="Speichern" Command="{Binding SpeichernCommand}"/>
                                    <Button Content="Neu" Command="{Binding NeuCommand}"/>
                                    <Button Content="Aktualisieren" Command="{Binding AktualisierenCommand}"/>
                                    <Button Content="Löschen" Command="{Binding LoeschenCommand}"/>
                                    <TextBlock Text="{Binding Status}" Foreground="Gray" VerticalAlignment="Center"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <TextBlock Margin="0,16,0,4" Text="Vorhandene Personen" FontWeight="SemiBold"/>
                        <Border BorderBrush="{DynamicResource ThemeBorderLowBrush}" BorderThickness="1" CornerRadius="6">
                            <ListBox ItemsSource="{Binding GefiltertePersonen}" SelectedItem="{Binding SelectedPerson, Mode=TwoWay}" MinHeight="200" MaxHeight="300">
                                <ListBox.Styles>
                                    <Style Selector="ListBox > ListBoxItem:nth-child(odd)">
                                        <Setter Property="Background" Value="#12FFFFFF"/>
                                    </Style>
                                </ListBox.Styles>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="8,6" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource ThemeBorderLowBrush}">
                                            <TextBlock Text="{Binding Name}"/>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </TabItem>

        <TabItem x:Name="ErfassungTab" Header="Schnellerfassung">
            <Grid RowDefinitions="Auto,* ,Auto">
            <StackPanel Grid.Row="0" Spacing="8" Margin="12" DataContext="{Binding Erfassung}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Datum:" VerticalAlignment="Center"/>
                    <DatePicker SelectedDate="{Binding SelectedDate, Mode=TwoWay}"/>
                    <Button Content="Heute" Command="{Binding HeuteCommand}"/>
                    <Button Content="Alle Mengen = 0" Command="{Binding AlleMengenNullCommand}"/>
                    <Button Content="Lieferung zurücksetzen" Command="{Binding ResetLieferungCommand}"/>
                    <Button Content="Speichern" Command="{Binding SpeichernCommand}"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" MinHeight="300" MaxHeight="500">
                    <ListBox x:Name="ErfassungList" ItemsSource="{Binding Zeilen}" SelectionMode="Single">
                        <ListBox.Styles>
                            <!-- zebra stripes: very light overlay on odd rows -->
                            <Style Selector="ListBox#ErfassungList > ListBoxItem:nth-child(odd)">
                                <Setter Property="Background" Value="#10FFFFFF"/>
                            </Style>
                        </ListBox.Styles>

                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:ErfassungViewModel+Row">
                                <Border Padding="4" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource ThemeBorderLowBrush}">
                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8" VerticalAlignment="Center">
                                        <TextBlock Grid.Column="0" Text="{Binding DisplayName}"/>
                                        <NumericUpDown Grid.Column="1" Width="100" Minimum="0" Maximum="50" Value="{Binding Quantity, Mode=TwoWay}"/>
                                        <CheckBox Grid.Column="2" Content="Lieferung?" IsChecked="{Binding Delivery, Mode=TwoWay}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </ScrollViewer>

                <TextBlock Text="{Binding Status}" Foreground="Gray"/>
            </StackPanel>
            </Grid>
        </TabItem>

        <TabItem Header="Etagenträger">
            <Grid RowDefinitions="Auto,*,Auto">
                <StackPanel Grid.Row="0" Spacing="12" Margin="16" DataContext="{Binding Etagentraeger}">
                    <TextBlock Text="Etagenträger nachträglich hinzufügen" FontWeight="SemiBold" FontSize="14"/>
                    <TextBlock Text="Hier können Etagenträger für Pensionisten nachträglich hinzugefügt werden, wenn diese bestätigen dass es passt." 
                               TextWrapping="Wrap" Foreground="Gray" FontSize="12"/>

                    <Border BorderBrush="{DynamicResource ThemeBorderLowBrush}" BorderThickness="1" CornerRadius="6" Padding="12" Background="{DynamicResource ThemeControlLowBrush}">
                        <StackPanel Spacing="12">
                            <TextBlock Text="Neuen Etagenträger hinzufügen" FontWeight="SemiBold"/>
                            <Grid ColumnDefinitions="Auto,2*,Auto,*,Auto,*,Auto,*,Auto" ColumnSpacing="12" RowSpacing="8">
                                <TextBlock Grid.Column="0" Text="Person:" VerticalAlignment="Center"/>
                                <ComboBox Grid.Column="1" ItemsSource="{Binding PersonenListe}" SelectedItem="{Binding SelectedPerson, Mode=TwoWay}" 
                                         PlaceholderText="Pensionist auswählen">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>

                                <TextBlock Grid.Column="2" Text="Monat:" VerticalAlignment="Center"/>
                                <NumericUpDown Grid.Column="3" Minimum="1" Maximum="12" Value="{Binding Monat, Mode=TwoWay}"/>

                                <TextBlock Grid.Column="4" Text="Jahr:" VerticalAlignment="Center"/>
                                <NumericUpDown Grid.Column="5" Minimum="2020" Maximum="2100" Value="{Binding Jahr, Mode=TwoWay}"/>

                                <TextBlock Grid.Column="6" Text="Anzahl:" VerticalAlignment="Center"/>
                                <NumericUpDown Grid.Column="7" Minimum="1" Maximum="10" Value="{Binding AnzahlTraeger, Mode=TwoWay}"/>

                                <Button Grid.Column="8" Content="Hinzufügen" Command="{Binding HinzufuegenCommand}"/>
                            </Grid>
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <Button Content="Aktualisieren" Command="{Binding LadenCommand}"/>
                                <TextBlock Text="{Binding Status}" Foreground="Gray" VerticalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <TextBlock Text="Vorhandene Etagenträger für aktuellen Monat" FontWeight="SemiBold"/>
                </StackPanel>

                <Border Grid.Row="1" BorderBrush="{DynamicResource ThemeBorderLowBrush}" BorderThickness="1" CornerRadius="6" Margin="16,0">
                    <ListBox ItemsSource="{Binding EtagentraegerListe}" MinHeight="200" MaxHeight="400" DataContext="{Binding Etagentraeger}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="12,8" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource ThemeBorderLowBrush}">
                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="{Binding Person.Name}" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding Description}" FontSize="11" Foreground="Gray"/>
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Text="{Binding Quantity}"/>
                                                <TextBlock Text=" Etagenträger (nur Menge - kein Preis)" FontStyle="Italic" Foreground="Gray"/>
                                            </StackPanel>
                                        </StackPanel>
                                        <TextBlock Grid.Column="1" Text="{Binding Month, StringFormat='{}{0:MM/yyyy}'}" VerticalAlignment="Center" FontWeight="Medium"/>
                                        <Button Grid.Column="2" Content="Löschen" 
                                               Command="{Binding $parent[ListBox].DataContext.LoeschenCommand}" 
                                               CommandParameter="{Binding}"
                                               Background="#FFEE5555" Foreground="White"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Border>
            </Grid>
        </TabItem>

        <TabItem Header="Abrechnung">
            <Grid RowDefinitions="Auto,* ,Auto">
            <StackPanel Grid.Row="0" Spacing="8" Margin="12" DataContext="{Binding Abrechnung}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Monat:" VerticalAlignment="Center"/>
                    <NumericUpDown Minimum="1" Maximum="12" Value="{Binding Monat, Mode=TwoWay}"/>
                    <TextBlock Text="Jahr:" VerticalAlignment="Center"/>
                    <NumericUpDown Minimum="2020" Maximum="2100" Value="{Binding Jahr, Mode=TwoWay}"/>
                    <Button Content="Berechnen" Command="{Binding BerechnenCommand}"/>
                    <Button Content="PDF exportieren" Command="{Binding ExportPdfCommand}" IsEnabled="{Binding KannExportieren}"/>
                </StackPanel>
                <ListBox Grid.Row="1" ItemsSource="{Binding Zeilen}" MinHeight="300" MaxHeight="500"/>
                <StackPanel Orientation="Vertical" Spacing="4">
                    <TextBlock Text="Summen" FontWeight="Bold"/>
                    <TextBlock Text="{Binding SummePensionisten, StringFormat='Pensionisten: {0:C}'}"/>
                    <TextBlock Text="{Binding SummeKinder, StringFormat='Kinder: {0:C}'}"/>
                    <TextBlock Text="{Binding SummeGratis, StringFormat='Gratis: {0:C}'}"/>
                    <TextBlock Text="{Binding SummeGesamt, StringFormat='Gesamt: {0:C}'}" FontWeight="Bold"/>
                </StackPanel>
                <TextBlock Text="{Binding Status}" Foreground="Gray"/>
            </StackPanel>
            </Grid>
        </TabItem>
        </TabControl>
        
        <!-- Status Bar -->
        <Border Grid.Row="1" Background="{DynamicResource ThemeControlLowBrush}" 
               BorderBrush="{DynamicResource ThemeBorderLowBrush}" 
               BorderThickness="0,1,0,0" 
               Padding="12,6">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" 
                          Text="Developed by Lechner Tobias v1.3.1.1 / Code: https://github.com/Zobiii/SchulkuecheMonatsabrechnung"
                          FontSize="10" 
                          Foreground="Gray" 
                          VerticalAlignment="Center"/>
                          
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="|" 
                              FontSize="10" 
                              Foreground="Gray" 
                              VerticalAlignment="Center"/>
                              
                    <TextBlock Text="{Binding CurrentUser.Username, StringFormat='Benutzer: {0}', FallbackValue='Benutzer: Unbekannt'}" 
                              FontSize="10" 
                              Foreground="Gray" 
                              FontWeight="SemiBold"
                              VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>

</Window>
